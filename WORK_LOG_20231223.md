# ì‘ì—… ë¡œê·¸ - 2023ë…„ 12ì›” 23ì¼

## ğŸ“‹ ì‘ì—… ìš”ì•½

Water_AI_Report_Gen (APAS) í”„ë¡œì íŠ¸ì˜ ì¸ì¦ ë° AI ì„œë¹„ìŠ¤ ê°œì„  ì‘ì—…

---

## ğŸ”§ ì£¼ìš” ì‘ì—… ë‚´ì—­

### 1. JWT í† í° ë§Œë£Œ ì‹œê°„ ì—°ì¥ (365ì¼)

#### **ë¬¸ì œ**

- ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ í›„ 1ì‹œê°„ë§ˆë‹¤ ì¬ë¡œê·¸ì¸ í•„ìš”
- "ì¸ì¦ í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤" ì—ëŸ¬ ì§€ì† ë°œìƒ

#### **í•´ê²°**

- Access Token ë§Œë£Œ ì‹œê°„: `1h` â†’ `365d`
- Refresh Token ë§Œë£Œ ì‹œê°„: `7d` â†’ `365d`

#### **ë³€ê²½ íŒŒì¼**

- `backend/src/utils/jwt.ts`

  ```typescript
  const JWT_EXPIRES_IN = process.env.JWT_EXPIRES_IN || '365d'
  const REFRESH_TOKEN_EXPIRES_IN = process.env.REFRESH_TOKEN_EXPIRES_IN || '365d'
  ```

- `.env.example`
  ```env
  JWT_EXPIRES_IN=365d
  REFRESH_TOKEN_EXPIRES_IN=365d
  ```

#### **Git ì»¤ë°‹**

```
0558290 - feat: Extend JWT token expiration to 365 days for development
18b6670 - feat: Add remote deployment script for JWT update
```

---

### 2. Gemini API í• ë‹¹ëŸ‰ ì´ˆê³¼ ë¬¸ì œ í•´ê²°

#### **ë¬¸ì œ**

```
GoogleGenerativeAIFetchError: [429 Too Many Requests]
You exceeded your current quota
Quota exceeded for metric: generativelanguage.googleapis.com/generate_content_free_tier_requests
```

#### **í•´ê²°**

- **Claude APIë¡œ ì „í™˜** (ë” ì•ˆì •ì ì´ê³  ê¸´ ë¬¸ì„œ ì²˜ë¦¬ ê°€ëŠ¥)
- AI Provider ì„ íƒ ê¸°ëŠ¥ ì¶”ê°€
- í™˜ê²½ë³€ìˆ˜ `AI_PROVIDER`ë¡œ ì œì–´

#### **ìƒˆë¡œ ì¶”ê°€ëœ ê¸°ëŠ¥**

**1. AI Provider ì„ íƒ ì‹œìŠ¤í…œ**

```typescript
// backend/src/controllers/analysisController.ts
const AI_PROVIDER = process.env.AI_PROVIDER || 'claude'
const analyzeDocument = AI_PROVIDER === 'claude' ? analyzeDocumentClaude : analyzeDocumentGemini
```

**2. Claude ë¬¸ì„œ ë¶„ì„ í•¨ìˆ˜**

```typescript
// backend/src/services/claudeService.ts
export const analyzeDocument = async (text: string): Promise<DocumentAnalysis>
```

- ìµœëŒ€ 100,000ì ë¬¸ì„œ ë¶„ì„ ê°€ëŠ¥ (Gemini: 50,000ì)
- JSON ì‘ë‹µ ìë™ íŒŒì‹±
- ìƒì„¸í•œ ì—ëŸ¬ ë¡œê¹…
- í† í° ì‚¬ìš©ëŸ‰ ì¶”ì 

**3. ìƒì„¸í•œ ì—ëŸ¬ ë¡œê¹…**

```typescript
console.log(`ğŸ¤– Starting AI document analysis with ${AI_PROVIDER.toUpperCase()}...`)
console.log(`ğŸ“„ Document text length: ${documentText.length} characters`)
console.log(`âœ… AI analysis completed successfully with ${AI_PROVIDER.toUpperCase()}`)
```

#### **í™˜ê²½ë³€ìˆ˜ ì¶”ê°€**

```env
# AI Provider Selection (claude or gemini)
AI_PROVIDER=claude
```

#### **Git ì»¤ë°‹**

```
8f0d8fb - fix: Switch to Claude API to resolve Gemini quota limit
a11b64d - feat: Add Gemini quota fix deployment script
```

---

### 3. ë°°í¬ ìë™í™” ìŠ¤í¬ë¦½íŠ¸ ìƒì„±

#### **ìƒì„±ëœ ìŠ¤í¬ë¦½íŠ¸**

**1. `update-jwt-config.sh`**

- JWT ì„¤ì • ì—…ë°ì´íŠ¸ ë° Docker ì¬ë°°í¬
- .env íŒŒì¼ ìë™ ì—…ë°ì´íŠ¸
- ë°±ì—… ë° í—¬ìŠ¤ì²´í¬ í¬í•¨

**2. `remote-deploy-jwt-update.sh`**

- CentOS ì›ê²© ì„œë²„ìš© JWT ì—…ë°ì´íŠ¸ ìŠ¤í¬ë¦½íŠ¸
- Git pull + .env ì—…ë°ì´íŠ¸ + Docker ì¬ë¹Œë“œ
- ë¡¤ë°± ê°€ì´ë“œ í¬í•¨

**3. `quick-deploy.sh`**

- ì¼ë°˜ì ì¸ ì½”ë“œ ì—…ë°ì´íŠ¸ìš© ë¹ ë¥¸ ë°°í¬
- ë³€ê²½ì‚¬í•­ ìë™ ê°ì§€
- Git stash/pop ìë™ ì²˜ë¦¬
- ë³€ê²½ì‚¬í•­ ì—†ìœ¼ë©´ ë°°í¬ ìŠ¤í‚µ

**4. `fix-gemini-quota.sh`**

- Gemini â†’ Claude ì „í™˜ ìë™í™”
- AI_PROVIDER í™˜ê²½ë³€ìˆ˜ ì„¤ì •
- Claude API í‚¤ í™•ì¸
- Docker ì¬ë¹Œë“œ ë° ê²€ì¦

**5. `debug-error.sh`**

- ì—ëŸ¬ ë””ë²„ê¹… ì •ë³´ ìˆ˜ì§‘
- Docker ìƒíƒœ, ë¡œê·¸, í™˜ê²½ë³€ìˆ˜ í™•ì¸
- í—¬ìŠ¤ì²´í¬ ë° ë””ìŠ¤í¬ ê³µê°„ í™•ì¸

#### **Git ì»¤ë°‹**

```
595cec4 - feat: Add quick deployment script
```

---

## ğŸ“ ë³€ê²½ëœ íŒŒì¼ ëª©ë¡

### **ë°±ì—”ë“œ ì½”ë“œ**

```
backend/src/
â”œâ”€â”€ utils/jwt.ts                      # JWT ë§Œë£Œ ì‹œê°„ 365ì¼ë¡œ ë³€ê²½
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ geminiService.ts             # ì—ëŸ¬ ë¡œê¹… ê°œì„ 
â”‚   â””â”€â”€ claudeService.ts             # analyzeDocument í•¨ìˆ˜ ì¶”ê°€
â””â”€â”€ controllers/
    â””â”€â”€ analysisController.ts         # AI Provider ì„ íƒ ë¡œì§ ì¶”ê°€
```

### **í™˜ê²½ ì„¤ì •**

```
.env.example                          # JWT ë° AI_PROVIDER ì„¤ì • ì¶”ê°€
```

### **ë°°í¬ ìŠ¤í¬ë¦½íŠ¸**

```
update-jwt-config.sh                  # JWT ì—…ë°ì´íŠ¸
remote-deploy-jwt-update.sh           # ì›ê²© JWT ë°°í¬
quick-deploy.sh                       # ë¹ ë¥¸ ë°°í¬
fix-gemini-quota.sh                   # Gemini ë¬¸ì œ í•´ê²°
debug-error.sh                        # ë””ë²„ê¹… ë„êµ¬
```

---

## ğŸš€ CentOS ì„œë²„ ë°°í¬ ê°€ì´ë“œ

### **ë°©ë²• 1: Gemini í• ë‹¹ëŸ‰ ë¬¸ì œ í•´ê²° (ìš°ì„ )**

```bash
ssh centos@1.236.245.110
cd /home/centos/SHINHWA_AI/1.AI_Report/Water_AI_Report_Gen
bash fix-gemini-quota.sh
```

### **ë°©ë²• 2: ì¼ë°˜ ì½”ë“œ ì—…ë°ì´íŠ¸**

```bash
ssh centos@1.236.245.110
cd /home/centos/SHINHWA_AI/1.AI_Report/Water_AI_Report_Gen
bash quick-deploy.sh
```

### **ë°©ë²• 3: ìˆ˜ë™ ë°°í¬**

```bash
ssh centos@1.236.245.110
cd /home/centos/SHINHWA_AI/1.AI_Report/Water_AI_Report_Gen

# ì½”ë“œ ì—…ë°ì´íŠ¸
git stash
git pull origin main

# .env ì—…ë°ì´íŠ¸ (í•„ìš”ì‹œ)
vi .env
# AI_PROVIDER=claude ì¶”ê°€

# Docker ì¬ì‹œì‘
docker-compose down
docker-compose build --no-cache
docker-compose up -d

# ë¡œê·¸ í™•ì¸
docker-compose logs -f apas
```

---

## âœ… ë°°í¬ í›„ í™•ì¸ ì‚¬í•­

### **1. ì„œë¹„ìŠ¤ ìƒíƒœ**

```bash
# í—¬ìŠ¤ì²´í¬
curl http://1.236.245.110:8021/api/v1/health
curl http://1.236.245.110:8020

# ì»¨í…Œì´ë„ˆ ìƒíƒœ
docker-compose ps
```

### **2. AI Provider í™•ì¸**

```bash
# ë¡œê·¸ì—ì„œ AI Provider ì´ˆê¸°í™” í™•ì¸
docker-compose logs apas | grep -i "claude\|gemini"

# ì˜ˆìƒ ì¶œë ¥:
# âœ… Claude API initialized with key: sk-ant-api...
```

### **3. í™˜ê²½ë³€ìˆ˜ í™•ì¸**

```bash
# .env íŒŒì¼ í™•ì¸
cat .env | grep -E "AI_PROVIDER|JWT_EXPIRES_IN"

# ì˜ˆìƒ ì¶œë ¥:
# AI_PROVIDER=claude
# JWT_EXPIRES_IN=365d
# REFRESH_TOKEN_EXPIRES_IN=365d
```

---

## ğŸ” ë¬¸ì œ í•´ê²° ê°€ì´ë“œ

### **ë¬¸ì œ 1: ì¸ì¦ í† í° ì—ëŸ¬**

```json
{ "success": false, "error": { "code": "UNAUTHORIZED", "message": "ì¸ì¦ í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤" } }
```

**í•´ê²°**:

1. ë¸Œë¼ìš°ì €ì—ì„œ ë¡œê·¸ì•„ì›ƒ í›„ ì¬ë¡œê·¸ì¸
2. ìƒˆ í† í°ì€ 365ì¼ê°„ ìœ íš¨

### **ë¬¸ì œ 2: Gemini 429 ì—ëŸ¬**

```
429 Too Many Requests - Quota exceeded
```

**í•´ê²°**:

```bash
bash fix-gemini-quota.sh
```

### **ë¬¸ì œ 3: Docker ë¹Œë“œ ì‹¤íŒ¨**

**í•´ê²°**:

```bash
docker-compose down -v
docker system prune -a
docker-compose build --no-cache
docker-compose up -d
```

### **ë¬¸ì œ 4: ì¼ë°˜ ì—ëŸ¬ ë””ë²„ê¹…**

**í•´ê²°**:

```bash
bash debug-error.sh
```

---

## ğŸ“Š Git ì»¤ë°‹ íˆìŠ¤í† ë¦¬

```
a11b64d - feat: Add Gemini quota fix deployment script
8f0d8fb - fix: Switch to Claude API to resolve Gemini quota limit
595cec4 - feat: Add quick deployment script
18b6670 - feat: Add remote deployment script for JWT update
0558290 - feat: Extend JWT token expiration to 365 days for development
```

**GitHub Repository**: https://github.com/axconkr/Water_AI_Report_Gen

---

## ğŸ¯ ë‹¤ìŒ ë‹¨ê³„ ê¶Œì¥ì‚¬í•­

### **ì¦‰ì‹œ ìˆ˜í–‰**

1. âœ… CentOS ì„œë²„ì—ì„œ `fix-gemini-quota.sh` ì‹¤í–‰
2. âœ… ë¬¸ì„œ ë¶„ì„ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
3. âœ… ë¡œê·¸ í™•ì¸í•˜ì—¬ Claude API ì •ìƒ ë™ì‘ í™•ì¸

### **ì¶”ê°€ ê°œì„ ì‚¬í•­ (ì„ íƒ)**

1. **Rate Limiting êµ¬í˜„**
   - Claude API ìš”ì²­ ì œí•œ ì„¤ì •
   - ì‚¬ìš©ìë‹¹ ì¼ì¼ ìš”ì²­ ì œí•œ

2. **ì—ëŸ¬ ì²˜ë¦¬ ê°œì„ **
   - Retry ë¡œì§ ì¶”ê°€
   - Fallback ë©”ì»¤ë‹ˆì¦˜ (Claude â†’ Gemini)

3. **ëª¨ë‹ˆí„°ë§ ê°•í™”**
   - AI API ì‚¬ìš©ëŸ‰ ëŒ€ì‹œë³´ë“œ
   - í† í° ì‚¬ìš©ëŸ‰ ì¶”ì 

4. **ìºì‹± êµ¬í˜„**
   - ë™ì¼ ë¬¸ì„œ ì¬ë¶„ì„ ë°©ì§€
   - Redis ìºì‹± layer ì¶”ê°€

---

## ğŸ“ í™˜ê²½ë³€ìˆ˜ ì „ì²´ ëª©ë¡

### **í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜**

```env
# Database
DATABASE_URL=postgresql://apas:apas_password@postgres:5432/apas_db

# AI Services (ë‘˜ ì¤‘ í•˜ë‚˜ í•„ìˆ˜)
ANTHROPIC_API_KEY=sk-ant-api03-...
# ë˜ëŠ”
CLAUDE_API_KEY=sk-ant-api03-...

# AI Provider
AI_PROVIDER=claude

# JWT
JWT_SECRET=your-secret-key
JWT_REFRESH_SECRET=your-refresh-secret
JWT_EXPIRES_IN=365d
REFRESH_TOKEN_EXPIRES_IN=365d

# Server
FRONTEND_PORT=3000
BACKEND_PORT=4000
NEXT_PUBLIC_API_URL=http://1.236.245.110:8021/api/v1
```

### **ì„ íƒ í™˜ê²½ë³€ìˆ˜**

```env
# Gemini (fallback)
GEMINI_API_KEY=your-gemini-key

# Logging
LOG_LEVEL=info

# Upload
UPLOAD_DIR=/app/uploads
MAX_FILE_SIZE=10485760
```

---

## ğŸ” ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

### **í”„ë¡œë•ì…˜ ë°°í¬ ì‹œ ë³€ê²½ í•„ìˆ˜**

1. **JWT Secret ë³€ê²½**

   ```env
   JWT_SECRET=<32ì ì´ìƒ ëœë¤ ë¬¸ìì—´>
   JWT_REFRESH_SECRET=<32ì ì´ìƒ ëœë¤ ë¬¸ìì—´>
   ```

2. **JWT ë§Œë£Œ ì‹œê°„ ì¬ì¡°ì •**

   ```env
   JWT_EXPIRES_IN=24h        # ê°œë°œ: 365d â†’ í”„ë¡œë•ì…˜: 24h
   REFRESH_TOKEN_EXPIRES_IN=7d
   ```

3. **API í‚¤ ë³´ì•ˆ**
   - `.env` íŒŒì¼ì€ ì ˆëŒ€ Gitì— ì»¤ë°‹í•˜ì§€ ì•Šê¸°
   - `.gitignore`ì— `.env` í¬í•¨ í™•ì¸

4. **CORS ì„¤ì • ê²€í† **
   - `backend/src/index.ts`ì˜ CORS origin ì„¤ì • í™•ì¸

---

## ğŸ“ ì§€ì› ë° ë¬¸ì˜

### **ë¬¸ì œ ë°œìƒ ì‹œ**

1. **ë¡œê·¸ ìˆ˜ì§‘**

   ```bash
   docker-compose logs apas > error.log
   bash debug-error.sh > debug.log
   ```

2. **GitHub Issues**
   https://github.com/axconkr/Water_AI_Report_Gen/issues

3. **ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§**
   ```bash
   docker-compose logs -f apas
   ```

---

## âœ¨ ì™„ë£Œëœ ì‘ì—… ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] JWT í† í° ë§Œë£Œ ì‹œê°„ 365ì¼ë¡œ ì—°ì¥
- [x] Gemini API í• ë‹¹ëŸ‰ ë¬¸ì œ í•´ê²° (Claude ì „í™˜)
- [x] AI Provider ì„ íƒ ì‹œìŠ¤í…œ êµ¬í˜„
- [x] Claude ë¬¸ì„œ ë¶„ì„ ê¸°ëŠ¥ ì¶”ê°€
- [x] ìƒì„¸í•œ ì—ëŸ¬ ë¡œê¹… ì¶”ê°€
- [x] ë°°í¬ ìë™í™” ìŠ¤í¬ë¦½íŠ¸ 5ê°œ ìƒì„±
- [x] ë””ë²„ê¹… ë„êµ¬ ìƒì„±
- [x] .env.example ì—…ë°ì´íŠ¸
- [x] Git ì»¤ë°‹ ë° í‘¸ì‹œ ì™„ë£Œ
- [x] ì‘ì—… ë¡œê·¸ ë¬¸ì„œí™”

---

**ì‘ì—… ì™„ë£Œ ì‹œê°**: 2023ë…„ 12ì›” 23ì¼
**ì‘ì„±ì**: Claude (AI Assistant)
**í”„ë¡œì íŠ¸**: Water_AI_Report_Gen (APAS)
